<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensi-Stream Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #333; }
        h1 { margin: 0; }
        #status { padding: 10px 0; font-style: italic; color: #888; }
        
        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .metric-card h3 { margin: 0 0 10px 0; color: #aaa; font-weight: normal; font-size: 16px; }
        .metric-card p { margin: 0; font-size: 28px; font-weight: bold; }

        /* --- Signal Box --- */
        .signal-box {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
        }
        .signal-box h2 { margin: 0 0 10px 0; font-size: 24px; }
        .signal-box p { margin: 0; font-size: 18px; }
        .signal-box.bullish { border-color: #27ae60; }
        .signal-box.bullish h2 { color: #2ecc71; }
        .signal-box.bearish { border-color: #c0392b; }
        .signal-box.bearish h2 { color: #e74c3c; }
        .signal-box.neutral { border-color: #7f8c8d; }
        .signal-box.neutral h2 { color: #95a5a6; }

        /* --- Options Chain Table --- */
        #options-chain-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        #options-chain-table thead th {
            background-color: #2a2a2a;
            padding: 12px 8px;
            border: 1px solid #444;
        }
        #options-chain-table tbody td {
            padding: 10px 8px;
            border: 1px solid #333;
            text-align: center;
        }
        #options-chain-table tbody tr:nth-child(even) { background-color: #1a1a1a; }
        #options-chain-table .strike-header,
        #options-chain-table .strike-data {
             background-color: #101010;
             font-weight: bold;
        }
        .atm-strike-row {
            background-color: #3a3a2a !important; /* ATM Highlight */
        }
        .call-side { color: #2ecc71; }
        .put-side { color: #e74c3c; }
        .positive-change { color: #2ecc71; }
        .negative-change { color: #e74c3c; }

        /* --- Utility & Details Element--- */
        #copy-button { background-color: #333; color: #e0e0e0; border: 1px solid #555; padding: 10px 20px; margin-top: 15px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
        #copy-button:hover { background-color: #444; }
        .disclaimer { font-size: 12px; color: #777; text-align: center; margin-top: 20px; }
        details { background-color: #1e1e1e; border: 1px solid #333; border-radius: 8px; margin: 20px 0; }
        details[open] { padding-bottom: 15px; }
        summary { padding: 15px; cursor: pointer; font-weight: bold; }
        pre { padding: 0 20px 20px 20px; font-size: 14px; white-space: pre-wrap; word-wrap: break-word; color: #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sensi-Stream Dashboard</h1>
            <div id="status">Connecting to server...</div>
        </div>

        <!-- Signal Box -->
        <div id="signal-container" class="signal-box neutral">
            <h2 id="signal-title">Waiting for Data...</h2>
            <p id="signal-details">--</p>
        </div>
        
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <div class="metric-card">
                <h3>Future Price</h3>
                <p id="future-price">--</p>
            </div>
            <div class="metric-card">
                <h3>ATM Strike</h3>
                <p id="atm-strike">--</p>
            </div>
            <div class="metric-card">
                <h3>PCR</h3>
                <p id="pcr">--</p>
            </div>
            <div class="metric-card">
                <h3>ATM IV</h3>
                <p id="atm-iv">--</p>
            </div>
            <div class="metric-card">
                <h3>Max Pain</h3>
                <p id="max-pain">--</p>
            </div>
        </div>
        
        <!-- Collapsible Options Chain Table -->
        <details>
            <summary id="options-chain-summary">View Options Chain</summary>
            <table id="options-chain-table">
                <thead>
                    <tr>
                        <th colspan="6" class="call-side">CALLS</th>
                        <th class="strike-header">STRIKE</th>
                        <th colspan="6" class="put-side">PUTS</th>
                    </tr>
                    <tr>
                        <th class="call-side">OI</th>
                        <th class="call-side">OI Chg %</th>
                        <th class="call-side">Volume</th>
                        <th class="call-side">IV</th>
                        <th class="call-side">Chg</th>
                        <th class="call-side">LTP</th>
                        <th class="strike-header"></th>
                        <th class="put-side">LTP</th>
                        <th class="put-side">Chg</th>
                        <th class="put-side">IV</th>
                        <th class="put-side">Volume</th>
                        <th class="put-side">OI Chg %</th>
                        <th class="put-side">OI</th>
                    </tr>
                </thead>
                <tbody id="options-chain-body">
                    <!-- Data will be dynamically inserted here -->
                </tbody>
            </table>
        </details>

        <!-- Collapsible Raw JSON Data -->
        <details>
            <summary id="raw-json-summary">View Raw JSON Data</summary>
            <button id="copy-button">Copy JSON to Clipboard</button>
            <pre id="data-container">Loading initial data...</pre>
        </details>
        
        <p class="disclaimer">
            <strong>Disclaimer:</strong> This is not financial advice. The signal is generated automatically based on the Put-Call Ratio and should be used for informational purposes only.
        </p>

    </div>

    <script>
        const PCR_BULLISH_THRESHOLD = 0.7;
        const PCR_BEARISH_THRESHOLD = 1.0;

        // --- Element References ---
        const statusDiv = document.getElementById('status');
        const signalContainer = document.getElementById('signal-container');
        const signalTitle = document.getElementById('signal-title');
        const signalDetails = document.getElementById('signal-details');
        const futurePriceEl = document.getElementById('future-price');
        const atmStrikeEl = document.getElementById('atm-strike');
        const pcrEl = document.getElementById('pcr');
        const atmIvEl = document.getElementById('atm-iv');
        const maxPainEl = document.getElementById('max-pain');
        const dataContainer = document.getElementById('data-container');
        const copyButton = document.getElementById('copy-button');
        const optionsChainBody = document.getElementById('options-chain-body');
        const optionsChainSummary = document.getElementById('options-chain-summary');
        const rawJsonSummary = document.getElementById('raw-json-summary');

        // --- Signal Generation Logic ---
        function generateSignal(pcr, atmStrike) {
            signalContainer.className = 'signal-box'; // Reset class
            if (pcr < PCR_BULLISH_THRESHOLD) {
                signalContainer.classList.add('bullish');
                signalTitle.textContent = 'Bullish Sentiment';
                signalDetails.textContent = `Consider CALLs | ATM Strike: ${atmStrike}`;
            } else if (pcr > PCR_BEARISH_THRESHOLD) {
                signalContainer.classList.add('bearish');
                signalTitle.textContent = 'Bearish Sentiment';
                signalDetails.textContent = `Consider PUTs | ATM Strike: ${atmStrike}`;
            } else {
                signalContainer.classList.add('neutral');
                signalTitle.textContent = 'Neutral Sentiment';
                signalDetails.textContent = `Market appears balanced | ATM Strike: ${atmStrike}`;
            }
        }
        
        // --- Options Chain Rendering Logic ---
        function renderOptionsChainTable(data) {
            if (!data || !data.chain) {
                optionsChainBody.innerHTML = '<tr><td colspan="13">Waiting for options chain data...</td></tr>';
                return;
            }

            const { chain, atm_strike } = data;
            const strikes = Object.keys(chain).sort((a, b) => Number(a) - Number(b));
            
            let tableHtml = '';

            for (const strike of strikes) {
                const isAtm = Number(strike) === atm_strike;
                const rowClass = isAtm ? 'atm-strike-row' : '';
                
                const call = chain[strike].call || {};
                const put = chain[strike].put || {};
                const greeks = chain[strike].greeks || {};

                const formatNum = (num, toLocale = true) => (num != null && num != 0) ? (toLocale ? num.toLocaleString('en-IN') : num) : '--';
                const formatIv = (iv) => (iv != null && iv != 0) ? `${(iv * 100).toFixed(1)}%` : '--';
                const formatOiChange = (oiChg) => (oiChg != null) ? `${(oiChg * 100).toFixed(1)}%` : '--';
                const formatChange = (chg) => {
                    if (chg == null) return '--';
                    const value = chg.toFixed(2);
                    const colorClass = chg > 0 ? 'positive-change' : (chg < 0 ? 'negative-change' : '');
                    return `<span class="${colorClass}">${value}</span>`;
                };

                tableHtml += `
                    <tr class="${rowClass}">
                        <td class="call-side">${formatNum(call.oi)}</td>
                        <td class="call-side">${formatOiChange(call.oi_change)}</td>
                        <td class="call-side">${formatNum(call.volume)}</td>
                        <td class="call-side">${formatIv(greeks.iv)}</td>
                        <td class="call-side">${formatChange(call.absolute_price_change)}</td>
                        <td class="call-side">${formatNum(call.last_price, false)}</td>
                        <td class="strike-data">${strike}</td>
                        <td class="put-side">${formatNum(put.last_price, false)}</td>
                        <td class="put-side">${formatChange(put.absolute_price_change)}</td>
                        <td class="put-side">${formatIv(greeks.iv)}</td>
                        <td class="put-side">${formatNum(put.volume)}</td>
                        <td class="put-side">${formatOiChange(put.oi_change)}</td>
                        <td class="put-side">${formatNum(put.oi)}</td>
                    </tr>
                `;
            }

            optionsChainBody.innerHTML = tableHtml;
        }

        // --- UI Update Function ---
        function updateDashboard(data) {
            if (!data || !data.future_price) {
                // Handle cases where there's no valid data yet
                dataContainer.textContent = JSON.stringify(data, null, 2);
                signalTitle.textContent = 'Waiting for Data...';
                signalDetails.textContent = 'No valid instrument data received yet.';
                return;
            }
            
            const { future_price, atm_strike, pcr, max_pain_strike, atm_iv } = data;
            
            futurePriceEl.textContent = future_price.toFixed(2);
            atmStrikeEl.textContent = atm_strike;
            pcrEl.textContent = pcr.toFixed(2);
            atmIvEl.textContent = `${(atm_iv * 100).toFixed(2)}%`;
            maxPainEl.textContent = max_pain_strike;
            
            generateSignal(pcr, atm_strike);
            renderOptionsChainTable(data);
            dataContainer.textContent = JSON.stringify(data, null, 2);
        }

        // --- WebSocket Handlers ---
        const socket = new WebSocket(`ws://localhost:3000`);

        socket.onopen = () => {
            // State is handled by onmessage now to ensure data has arrived
        };

        socket.onclose = () => {
            statusDiv.innerHTML = `ðŸ”´ <strong>Status:</strong> Disconnected. <strong>Restart the app for a live feed.</strong>`;
            optionsChainSummary.textContent = 'View Options Chain (Disconnected)';
            rawJsonSummary.textContent = 'View Raw JSON Data (Disconnected)';
        };
        
        socket.onerror = () => { 
            statusDiv.textContent = 'ðŸ”´ Connection error. Is the Sensi-Stream server running?';
        };

        socket.onmessage = (event) => {
            // This is now the single source of truth for updates.
            // The first message received will change the status from "Connecting" to "Live".
            statusDiv.innerHTML = `ðŸŸ¢ <strong>Status:</strong> Live data updated at <strong>${new Date().toLocaleTimeString()}</strong>`;
            optionsChainSummary.textContent = 'View Options Chain (Live Data)';
            rawJsonSummary.textContent = 'View Raw JSON Data (Live Data)';
            
            const data = JSON.parse(event.data);
            updateDashboard(data);
        };

        // --- Clipboard Logic ---
        copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(dataContainer.textContent).then(() => {
                copyButton.textContent = 'âœ… Copied!';
                setTimeout(() => { copyButton.textContent = 'Copy JSON to Clipboard'; }, 2000);
            }).catch(err => console.error('Failed to copy text', err));
        });

    </script>
</body>
</html>