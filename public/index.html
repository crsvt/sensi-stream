<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensi-Stream Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #333; }
        h1 { margin: 0; }
        #status { padding: 10px 0; font-style: italic; color: #888; }
        
        /* --- Dashboard Grid --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .metric-card h3 { margin: 0 0 10px 0; color: #aaa; font-weight: normal; font-size: 16px; }
        .metric-card p { margin: 0; font-size: 28px; font-weight: bold; }

        /* --- Signal Box --- */
        .signal-box {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
        }
        .signal-box h2 { margin: 0 0 10px 0; font-size: 24px; }
        .signal-box p { margin: 0; font-size: 18px; }
        .signal-box.bullish { border-color: #27ae60; }
        .signal-box.bullish h2 { color: #2ecc71; }
        .signal-box.bearish { border-color: #c0392b; }
        .signal-box.bearish h2 { color: #e74c3c; }
        .signal-box.neutral { border-color: #7f8c8d; }
        .signal-box.neutral h2 { color: #95a5a6; }

        /* --- Utility --- */
        #copy-button { background-color: #333; color: #e0e0e0; border: 1px solid #555; padding: 10px 20px; margin-top: 15px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
        #copy-button:hover { background-color: #444; }
        .disclaimer { font-size: 12px; color: #777; text-align: center; margin-top: 20px; }
        details { background-color: #1e1e1e; border: 1px solid #333; border-radius: 8px; margin: 20px 0; }
        summary { padding: 15px; cursor: pointer; font-weight: bold; }
        pre { padding: 0 20px 20px 20px; font-size: 14px; white-space: pre-wrap; word-wrap: break-word; color: #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sensi-Stream Dashboard</h1>
            <div id="status">Connecting to server...</div>
        </div>

        <!-- Signal Box -->
        <div id="signal-container" class="signal-box neutral">
            <h2 id="signal-title">Waiting for Data...</h2>
            <p id="signal-details">--</p>
        </div>
        
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <div class="metric-card">
                <h3>Future Price</h3>
                <p id="future-price">--</p>
            </div>
            <div class="metric-card">
                <h3>ATM Strike</h3>
                <p id="atm-strike">--</p>
            </div>
            <div class="metric-card">
                <h3>PCR</h3>
                <p id="pcr">--</p>
            </div>
            <div class="metric-card">
                <h3>ATM IV</h3>
                <p id="atm-iv">--</p>
            </div>
            <div class="metric-card">
                <h3>Max Pain</h3>
                <p id="max-pain">--</p>
            </div>
        </div>
        
        <p class="disclaimer">
            <strong>Disclaimer:</strong> This is not financial advice. The signal is generated automatically based on the Put-Call Ratio and should be used for informational purposes only.
        </p>

        <!-- Collapsible Raw JSON Data -->
        <details>
            <summary>View Raw JSON Data</summary>
            <button id="copy-button">Copy JSON to Clipboard</button>
            <pre id="data-container">Loading initial data...</pre>
        </details>
    </div>

    <script>
        const PCR_BULLISH_THRESHOLD = 0.7;
        const PCR_BEARISH_THRESHOLD = 1.0;

        // --- Element References ---
        const statusDiv = document.getElementById('status');
        const signalContainer = document.getElementById('signal-container');
        const signalTitle = document.getElementById('signal-title');
        const signalDetails = document.getElementById('signal-details');
        const futurePriceEl = document.getElementById('future-price');
        const atmStrikeEl = document.getElementById('atm-strike');
        const pcrEl = document.getElementById('pcr');
        const atmIvEl = document.getElementById('atm-iv');
        const maxPainEl = document.getElementById('max-pain');
        const dataContainer = document.getElementById('data-container');
        const copyButton = document.getElementById('copy-button');

        // --- Signal Generation Logic ---
        function generateSignal(pcr, atmStrike) {
            signalContainer.className = 'signal-box'; // Reset class
            if (pcr < PCR_BULLISH_THRESHOLD) {
                signalContainer.classList.add('bullish');
                signalTitle.textContent = 'Bullish Sentiment';
                signalDetails.textContent = `Consider CALLs | ATM Strike: ${atmStrike}`;
            } else if (pcr > PCR_BEARISH_THRESHOLD) {
                signalContainer.classList.add('bearish');
                signalTitle.textContent = 'Bearish Sentiment';
                signalDetails.textContent = `Consider PUTs | ATM Strike: ${atmStrike}`;
            } else {
                signalContainer.classList.add('neutral');
                signalTitle.textContent = 'Neutral Sentiment';
                signalDetails.textContent = `Market appears balanced | ATM Strike: ${atmStrike}`;
            }
        }

        // --- UI Update Function ---
        function updateDashboard(data) {
            if (!data || !data.future_price) {
                // Handle cases where data is not yet available
                dataContainer.textContent = JSON.stringify(data, null, 2);
                return;
            }
            
            const { future_price, atm_strike, pcr, max_pain_strike, atm_iv } = data;
            
            // Update metric cards
            futurePriceEl.textContent = future_price.toFixed(2);
            atmStrikeEl.textContent = atm_strike;
            pcrEl.textContent = pcr.toFixed(2);
            atmIvEl.textContent = `${(atm_iv * 100).toFixed(2)}%`;
            maxPainEl.textContent = max_pain_strike;
            
            // Generate and display the signal
            generateSignal(pcr, atm_strike);
            
            // Update the raw data view
            dataContainer.textContent = JSON.stringify(data, null, 2);
        }

        // --- WebSocket Handlers ---
        const socket = new WebSocket(`ws://localhost:3000`);
        socket.onopen = () => { statusDiv.textContent = 'ðŸŸ¢ Connected. Waiting for live data...'; };
        socket.onclose = () => { statusDiv.textContent = 'ðŸ”´ Disconnected. Please restart the application.'; };
        socket.onerror = () => { statusDiv.textContent = 'ðŸ”´ Connection error.'; };
        socket.onmessage = (event) => {
            statusDiv.innerHTML = `ðŸŸ¢ Live data updated at <strong>${new Date().toLocaleTimeString()}</strong>`;
            const data = JSON.parse(event.data);
            updateDashboard(data);
        };

        // --- Initial Data Load ---
        async function loadInitialData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                dataContainer.textContent = 'Error loading initial data.';
                console.error(error);
            }
        }
        loadInitialData();

        // --- Clipboard Logic ---
        copyButton.addEventListener('click', () => {
            navigator.clipboard.writeText(dataContainer.textContent).then(() => {
                copyButton.textContent = 'âœ… Copied!';
                setTimeout(() => { copyButton.textContent = 'Copy JSON to Clipboard'; }, 2000);
            }).catch(err => console.error('Failed to copy text', err));
        });

    </script>
</body>
</html>