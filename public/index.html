<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensi-Stream Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-start-rgb: 13, 17, 23;
            --background-end-rgb: 22, 27, 34;
            --card-background: rgba(22, 27, 34, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-color: #00aaff;
            --accent-glow-color: rgba(0, 170, 255, 0.5);
            --text-primary: #e6edf3;
            --text-secondary: #7d8590;
            --text-tertiary: #555c64;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }

        /* --- Base & Body --- */
        *, *::before, *::after { box-sizing: border-box; }
        
        body {
            font-family: var(--font-family);
            background-color: rgb(var(--background-start-rgb));
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background-image: 
                radial-gradient(at 20% 20%, hsla(212, 89%, 35%, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 20%, hsla(284, 89%, 35%, 0.15) 0px, transparent 50%),
                radial-gradient(at 20% 80%, hsla(180, 89%, 35%, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 80%, hsla(35, 89%, 35%, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }

        /* --- Header --- */
        .header {
            text-align: center;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            margin-bottom: 2rem;
        }
        .header h1 {
            margin: 0;
            font-weight: 700;
            font-size: 2.25rem;
            color: #fff;
            letter-spacing: -1px;
            text-shadow: 0 0 15px var(--accent-glow-color);
        }
        #status { padding: 0.5rem 0; font-style: italic; color: var(--text-secondary); font-size: 0.9rem; }

        /* --- Card System --- */
        .card {
            background: var(--card-background);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .card:hover {
            border-color: var(--accent-color);
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2), 0 0 15px var(--accent-glow-color);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border-color);
        }
        .card-header h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .card-header .icon {
            stroke: var(--text-secondary);
            width: 20px;
            height: 20px;
        }
        .card-content { padding: 1.5rem; }

        /* --- Main Layout Grid --- */
        .main-grid {
            display: grid;
            grid-template-columns: minmax(400px, 1fr) 2fr;
            gap: 1.5rem;
        }
        .left-column, .right-column { display: flex; flex-direction: column; }

        /* --- Metric & Signal Cards --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .metric-card { padding: 1.25rem; background: transparent; border: 1px solid var(--border-color); border-radius: 10px; text-align: center; }
        .metric-card h3 { margin: 0 0 0.5rem 0; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; }
        .metric-card p { margin: 0; font-size: 1.75rem; font-weight: 600; color: #fff; }
        
        .signal-box { padding: 1.5rem; text-align: center; }
        .signal-box h2 { margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .signal-box p { margin: 0; font-size: 1rem; color: var(--text-secondary); }
        .signal-box.bullish { border-color: var(--success-color); box-shadow: 0 0 15px rgba(39, 174, 96, 0.3); }
        .signal-box.bullish h2 { color: var(--success-color); }
        .signal-box.bearish { border-color: var(--danger-color); box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); }
        .signal-box.bearish h2 { color: var(--danger-color); }
        .signal-box.neutral { border-color: var(--text-secondary); }
        .signal-box.neutral h2 { color: var(--text-secondary); }

        /* --- Controls & Buttons --- */
        textarea {
            width: 100%;
            box-sizing: border-box;
            height: 150px;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: 0.9rem;
            padding: 0.75rem;
            resize: vertical;
            margin-bottom: 1rem;
        }
        .btn {
            width: 100%;
            color: #fff;
            border: none;
            padding: 0.8rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
             background-image: linear-gradient(to right, #00aaff, #0088cc);
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px var(--accent-glow-color);
        }
        .btn:disabled { background: var(--text-tertiary); cursor: not-allowed; opacity: 0.7; transform: none; box-shadow: none; }

        .icon-button {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .icon-button:hover {
            background-color: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }
        .icon-button .icon { width: 18px; height: 18px; }

        /* --- Settings Panel --- */
        .settings-wrapper { position: absolute; top: 1rem; right: 1rem; }
        #settings-panel {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            z-index: 100;
            width: 280px;
            background: #1c1c22;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #settings-panel h3 { margin-top: 0; text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; margin-bottom: 1rem; font-weight: 600; }
        .settings-group { display: flex; align-items: center; gap: 0.75rem; justify-content: space-between; margin-bottom: 1rem; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }
        .info-text { font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin-top: -0.5rem; padding-bottom: 0.5rem; }
        .hidden { display: none !important; }

        /* --- AI Report & Data Views --- */
        .timer { font-size: 0.85rem; font-weight: 400; color: var(--text-secondary); margin-left: auto; }

        .ai-analysis-content { padding: 0 1.5rem 1.5rem 1.5rem; }
        
        /* --- Collapsible Section Styling --- */
        details {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            transition: background 0.3s ease;
        }
        details[open] {
            background: var(--card-background);
            backdrop-filter: blur(12px);
        }
        details:hover {
            border-color: var(--accent-color);
        }
        summary {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            list-style: none;
        }
        summary::-webkit-details-marker {
            display: none;
        }
        summary h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        details[open] > summary {
            border-bottom: 1px solid var(--border-color);
        }

        /* --- MODIFIED: Confluence Status Bar --- */
        .confluence-status {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center; /* This ensures vertical alignment */
            gap: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .status-confluence { color: var(--success-color); background-color: rgba(39, 174, 96, 0.1); border-bottom-color: var(--success-color); }
        .status-caution { color: var(--warning-color); background-color: rgba(243, 156, 18, 0.1); border-bottom-color: var(--warning-color); }
        .status-divergence { color: var(--danger-color); background-color: rgba(231, 76, 60, 0.1); border-bottom-color: var(--danger-color); }
        .status-neutral { color: var(--text-secondary); background-color: rgba(0,0,0,0.1); }
        .confluence-status .icon { width: 18px; height: 18px; flex-shrink: 0; } /* Added flex-shrink to prevent icon from shrinking */

        /* --- Trade Assistant Styles --- */
        .trade-assistant-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .trade-assistant-grid input {
            width: 100%;
            padding: 0.75rem;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .trade-type-toggle { display: flex; border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; }
        .trade-type-toggle button {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .trade-type-toggle button.active {
            background-color: var(--accent-color);
            color: #fff;
        }
        .btn-secondary {
            background-image: linear-gradient(to right, #3a3a4a, #2a2a3a);
        }
        .btn-secondary:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        /* --- Table & JSON View Styling --- */
        #options-chain-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        #options-chain-table thead th { background-color: rgba(42, 42, 52, 0.5); padding: 0.75rem 0.5rem; border: 1px solid var(--border-color); font-weight: 600; }
        #options-chain-table tbody td { padding: 0.6rem 0.5rem; border: 1px solid var(--border-color); text-align: center; }
        #options-chain-table .strike-header { background-color: #101010; font-weight: bold; }
        .atm-strike-row { background-color: rgba(58, 58, 42, 0.5) !important; }
        .call-side { color: var(--success-color); }
        .put-side { color: var(--danger-color); }
        .positive-change { color: var(--success-color); }
        .negative-change { color: var(--danger-color); }
        pre { padding: 1.5rem; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; color: #ccc; background-color: rgba(0,0,0,0.2); margin: 0; }
        .disclaimer { font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-top: 2rem; }

        /* --- MODIFIED: Strategy Display Box --- */
        #strategy-display {
            text-align: center;
            padding: 1.5rem;
            margin: 1.5rem;
            border-radius: 10px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        #strategy-display h2 {
            margin: 0 0 0.5rem 0;
            font-size: 2.25rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        #strategy-display p {
            margin: 0;
            font-size: 1rem;
            color: var(--text-secondary);
        }
        .strategy-bullish {
            border-color: var(--success-color);
            background: linear-gradient(rgba(39, 174, 96, 0.1), rgba(39, 174, 96, 0));
        }
        .strategy-bullish h2 { color: var(--success-color); }
        .strategy-bearish {
            border-color: var(--danger-color);
            background: linear-gradient(rgba(231, 76, 60, 0.1), rgba(231, 76, 60, 0));
        }
        .strategy-bearish h2 { color: var(--danger-color); }
        .strategy-neutral {
            border-color: var(--text-secondary);
            background: linear-gradient(rgba(125, 133, 144, 0.1), rgba(125, 133, 144, 0));
        }
        .strategy-neutral h2 { color: var(--text-secondary); }

        /* --- MODIFIED: Enhanced AI Report List --- */
        .strategy-details-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .strategy-details-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            font-size: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .strategy-details-list li:last-child {
            border-bottom: none;
        }
        .strategy-details-list .data-label {
            color: var(--text-secondary);
            font-weight: 500;
        }
        .strategy-details-list .data-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
        }
        /* NEW: Class to override font size for non-critical data */
        .data-value.standard-text {
            font-size: 0.95rem;
            font-weight: 400;
            color: var(--text-secondary);
            text-align: right;
        }
        .data-value.stop-loss { color: var(--danger-color); }
        .data-value.target { color: var(--success-color); }
        .rationale {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        .rationale .data-value {
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sensi-Stream Dashboard</h1>
            <div id="status">Connecting to server...</div>
            <div class="settings-wrapper">
                <button id="settings-btn" class="icon-button">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.73l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2.73l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
                <div id="settings-panel" class="hidden">
                    <h3>Dashboard Settings</h3>
                    <div class="settings-group">
                        <label for="hybrid-toggle">Enable Hybrid Context</label>
                        <label class="toggle-switch"><input type="checkbox" id="hybrid-toggle"><span class="slider"></span></label>
                    </div>
                    <hr style="border-color: var(--border-color); margin: 1rem 0;">
                    <div class="settings-group">
                        <label for="show-sentiment-toggle">Show Sentiment Signal</label>
                        <label class="toggle-switch"><input type="checkbox" id="show-sentiment-toggle"><span class="slider"></span></label>
                    </div>
                    <div class="settings-group">
                        <label for="show-metrics-grid-toggle">Show Metrics Grid</label>
                        <label class="toggle-switch"><input type="checkbox" id="show-metrics-grid-toggle"><span class="slider"></span></label>
                    </div>
                    <div class="settings-group">
                        <label for="show-options-chain-toggle">Show Options Chain</label>
                        <label class="toggle-switch"><input type="checkbox" id="show-options-chain-toggle"><span class="slider"></span></label>
                    </div>
                    <div class="settings-group">
                        <label for="show-raw-json-toggle">Show Raw JSON Data</label>
                        <label class="toggle-switch"><input type="checkbox" id="show-raw-json-toggle"><span class="slider"></span></label>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- LEFT COLUMN -->
            <div class="left-column">
                <div class="card">
                    <div class="card-header">
                        <h2><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 0 0-2 19.52c.2.04.28-.08.28-.18v-1.5h-1.2c-.5 0-1-.2-1.2-.5-.2-.3-.4-.8-.5-1.2-.2-.5-.8-2-1.5-2.5-.8-.5-.3-1 .2-1 .5 0 1 .5 1.2 1 .2.5.8 1.5 2.5 1.5.5 0 1-.2 1.2-.5.2-.3.5-1.5.5-2V14c0-1-1-1.5-2-2-1-.5-2-1-2-2.5s1-2.5 2.5-2.5c1 0 1.8.5 2.2 1 .5-.2 1-.5 1.5-.8-.2-.5-.8-1.2-1.5-1.8C14.5 3.5 13.5 3 12 3a5 5 0 0 0-5 5c0 2.5 2 4 4 4.5v.5c0 .5-.2 1-.5 1.2-.3.2-.8.5-1.2.5H8v1.5c0 .1.08.22.28.18A10 10 0 0 0 12 2z"></path></svg>
                            <span>Hybrid Analysis Controls</span>
                        </h2>
                    </div>
                    <div class="card-content">
                        <textarea id="context-textarea" placeholder="Paste Market Context Summary here... (Optional)"></textarea>
                        <button id="run-now-btn" class="btn btn-primary">Generate AI Report</button>
                    </div>
                </div>

                <details class="card" id="trade-assistant-details">
                    <summary class="card-header">
                        <h2>
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
                            <span>Live Trade Assistant</span>
                        </h2>
                    </summary>
                    <div class="card-content">
                        <div class="trade-assistant-grid">
                            <div class="trade-type-toggle">
                                <button id="trade-type-call" class="active">CALL</button>
                                <button id="trade-type-put">PUT</button>
                            </div>
                            <input type="number" id="trade-lots" placeholder="Lots (e.g., 1)">
                            <input type="number" id="trade-strike" placeholder="Strike Price">
                            <input type="number" id="trade-entry" placeholder="Your Entry Price">
                        </div>
                        <button id="analyze-position-btn" class="btn btn-secondary">Analyze My Position</button>
                    </div>
                </details>

                <div class="card hidden" id="position-analysis-card">
                    <div class="card-header">
                        <h2>
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"></path><path d="M18 20V4"></path><path d="M6 20V16"></path></svg>
                            <span>Position Analysis Report</span>
                        </h2>
                    </div>
                    <div id="position-confluence-status" class="confluence-status status-neutral">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                        <span>Live monitor is now tracking this position.</span>
                    </div>
                    <div id="position-analysis-container" class="ai-analysis-content">Waiting for position analysis...</div>
                </div>

                <div id="signal-container-details" class="card signal-box neutral">
                    <h2 id="signal-title">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="4"></line><polyline points="18 10 12 4 6 10"></polyline></svg>
                        <span>Waiting for Data...</span>
                    </h2>
                    <p id="signal-details">--</p>
                </div>

                <div id="metrics-grid-details" class="card">
                    <div class="card-header">
                        <h2><svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                            <span>Key Metrics</span>
                        </h2>
                    </div>
                    <div class="card-content dashboard-grid">
                        <div class="metric-card"><h3>Future Price</h3><p id="future-price">--</p></div>
                        <div class="metric-card"><h3>ATM Strike</h3><p id="atm-strike">--</p></div>
                        <div class="metric-card"><h3>PCR</h3><p id="pcr">--</p></div>
                        <div class="metric-card"><h3>ATM IV</h3><p id="atm-iv">--</p></div>
                        <div class="metric-card"><h3>Max Pain</h3><p id="max-pain">--</p></div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="right-column">
                <details class="card" id="ai-report-details" open>
                    <summary class="card-header">
                        <h2>
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"></path><rect x="2" y="6" width="12" height="12" rx="2"></rect><path d="M12 12h4"></path><path d="M12 16h4"></path><path d="M16 12h4"></path><path d="M16 16h4"></path></svg>
                            <span>AI Analyst Report</span>
                        </h2>
                        <span id="ai-timer" class="timer">Waiting for first analysis...</span>
                    </summary>
                    <div id="strategy-display" class="strategy-neutral">
                        <h2 id="strategy-name">NO SIGNAL</h2>
                        <p id="strategy-strike">Generate a report to get the latest AI signal.</p>
                    </div>
                    <div id="ai-confluence-status" class="confluence-status status-neutral">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                        <span>Run analysis to activate live strategy monitor.</span>
                    </div>
                    <div id="ai-analysis-container" class="ai-analysis-content">
                        <!-- Content will be dynamically generated by JavaScript -->
                    </div>
                </details>

                <details id="options-chain-details">
                    <summary>
                        <h2>
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                            <span>Options Chain</span>
                        </h2>
                        <button id="copy-table-button" class="icon-button">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </summary>
                    <table id="options-chain-table"><thead><tr><th colspan="6" class="call-side">CALLS</th><th class="strike-header">STRIKE</th><th colspan="6" class="put-side">PUTS</th></tr><tr><th class="call-side">OI</th><th class="call-side">OI Chg %</th><th class="call-side">Volume</th><th class="call-side">IV</th><th class="call-side">Chg</th><th class="call-side">LTP</th><th class="strike-header"></th><th class="put-side">LTP</th><th class="put-side">Chg</th><th class="put-side">IV</th><th class="put-side">Volume</th><th class="put-side">OI Chg %</th><th class="put-side">OI</th></tr></thead><tbody id="options-chain-body"></tbody></table>
                </details>
                <details id="raw-json-details">
                    <summary>
                        <h2>
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                            <span>Raw JSON Data</span>
                        </h2>
                        <button id="copy-json-button" class="icon-button">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </summary>
                    <pre id="data-container">Loading initial data...</pre>
                </details>
            </div>
        </div>
        <p class="disclaimer"><strong>Disclaimer:</strong> This is not financial advice. The signal is generated automatically and should be used for informational purposes only.</p>
    </div>

    <script>
        // --- CONSTANTS AND ELEMENT GRABBING ---
        const PCR_BULLISH_THRESHOLD = 0.7;
        const PCR_BEARISH_THRESHOLD = 1.0;
        const statusDiv = document.getElementById('status');
        const futurePriceEl = document.getElementById('future-price');
        const atmStrikeEl = document.getElementById('atm-strike');
        const pcrEl = document.getElementById('pcr');
        const atmIvEl = document.getElementById('atm-iv');
        const maxPainEl = document.getElementById('max-pain');
        const dataContainer = document.getElementById('data-container');
        const optionsChainBody = document.getElementById('options-chain-body');
        const aiAnalysisContainer = document.getElementById('ai-analysis-container');
        const aiTimerEl = document.getElementById('ai-timer');
        const contextTextarea = document.getElementById('context-textarea');
        const runNowBtn = document.getElementById('run-now-btn');
        const aiReportDetails = document.getElementById('ai-report-details');
        const aiConfluenceStatus = document.getElementById('ai-confluence-status');
        
        const strategyDisplay = document.getElementById('strategy-display');
        const strategyName = document.getElementById('strategy-name');
        const strategyStrike = document.getElementById('strategy-strike');

        const analyzePositionBtn = document.getElementById('analyze-position-btn');
        const tradeTypeCallBtn = document.getElementById('trade-type-call');
        const tradeTypePutBtn = document.getElementById('trade-type-put');
        const positionAnalysisCard = document.getElementById('position-analysis-card');
        const positionAnalysisContainer = document.getElementById('position-analysis-container');
        const positionConfluenceStatus = document.getElementById('position-confluence-status');

        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const hybridToggle = document.getElementById('hybrid-toggle');
        const showSentimentToggle = document.getElementById('show-sentiment-toggle');
        const showMetricsGridToggle = document.getElementById('show-metrics-grid-toggle');
        const showOptionsChainToggle = document.getElementById('show-options-chain-toggle');
        const showRawJsonToggle = document.getElementById('show-raw-json-toggle');
        const signalContainerDetails = document.getElementById('signal-container-details');
        const metricsGridDetails = document.getElementById('metrics-grid-details');
        const optionsChainDetails = document.getElementById('options-chain-details');
        const rawJsonDetails = document.getElementById('raw-json-details');
        
        const signalContainer = document.getElementById('signal-container-details');
        const signalTitle = document.getElementById('signal-title');
        const signalDetails = document.getElementById('signal-details');

        // --- SETTINGS LOGIC ---
        function loadSettings() {
            const isHybridMode = localStorage.getItem('sensi-stream-isHybridMode') !== 'false';
            const showSentiment = localStorage.getItem('sensi-stream-showSentiment') === 'true';
            const showMetrics = localStorage.getItem('sensi-stream-showMetricsGrid') === 'true';
            const showChain = localStorage.getItem('sensi-stream-showOptionsChain') === 'true';
            const showJson = localStorage.getItem('sensi-stream-showRawJson') === 'true';

            hybridToggle.checked = isHybridMode;
            showSentimentToggle.checked = showSentiment;
            showMetricsGridToggle.checked = showMetrics;
            showOptionsChainToggle.checked = showChain;
            showRawJsonToggle.checked = showJson;

            signalContainerDetails.classList.toggle('hidden', !showSentiment);
            metricsGridDetails.classList.toggle('hidden', !showMetrics);
            optionsChainDetails.classList.toggle('hidden', !showChain);
            rawJsonDetails.classList.toggle('hidden', !showJson);
            
            updateHybridSetting(isHybridMode);
        }

        function saveSettings() {
            localStorage.setItem('sensi-stream-isHybridMode', hybridToggle.checked);
            localStorage.setItem('sensi-stream-showSentiment', showSentimentToggle.checked);
            localStorage.setItem('sensi-stream-showMetricsGrid', showMetricsGridToggle.checked);
            localStorage.setItem('sensi-stream-showOptionsChain', showOptionsChainToggle.checked);
            localStorage.setItem('sensi-stream-showRawJson', showRawJsonToggle.checked);
        }

        async function updateHybridSetting(isHybridMode) {
             try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isHybridMode }),
                });
            } catch (error) { console.error('Failed to save hybrid setting:', error); }
        }

        settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsPanel.classList.toggle('hidden'); });
        showSentimentToggle.addEventListener('change', () => { signalContainerDetails.classList.toggle('hidden', !showSentimentToggle.checked); saveSettings(); });
        showMetricsGridToggle.addEventListener('change', () => { metricsGridDetails.classList.toggle('hidden', !showMetricsGridToggle.checked); saveSettings(); });
        showOptionsChainToggle.addEventListener('change', () => { optionsChainDetails.classList.toggle('hidden', !showOptionsChainToggle.checked); saveSettings(); });
        showRawJsonToggle.addEventListener('change', () => { rawJsonDetails.classList.toggle('hidden', !showRawJsonToggle.checked); saveSettings(); });
        hybridToggle.addEventListener('change', () => { updateHybridSetting(hybridToggle.checked); saveSettings(); });
        window.addEventListener('click', (e) => { if (!settingsPanel.classList.contains('hidden') && !settingsPanel.contains(e.target) && e.target !== settingsBtn) { settingsPanel.classList.add('hidden'); } });

        // --- API & CONTEXT LOGIC ---
        async function saveContext() {
            try {
                await fetch('/api/context', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ context: contextTextarea.value }),
                });
            } catch (error) { console.error('Failed to save context:', error); }
        }

        runNowBtn.addEventListener('click', async () => {
            runNowBtn.textContent = 'Generating...';
            runNowBtn.disabled = true;
            await saveContext();
            try {
                const response = await fetch('/api/analyze-now', { method: 'POST' });
                if (!response.ok) { throw new Error('Analysis trigger failed'); }
            } catch (error) {
                aiAnalysisContainer.innerHTML = '<p style="color: var(--danger-color);"><strong>Error:</strong> Could not generate report. Check the server console for details.</p>';
            }
            setTimeout(() => {
                runNowBtn.textContent = 'Generate AI Report';
                runNowBtn.disabled = false;
            }, 1500);
        });

        tradeTypeCallBtn.addEventListener('click', () => {
            tradeTypeCallBtn.classList.add('active');
            tradeTypePutBtn.classList.remove('active');
        });
        tradeTypePutBtn.addEventListener('click', () => {
            tradeTypePutBtn.classList.add('active');
            tradeTypeCallBtn.classList.remove('active');
        });

        analyzePositionBtn.addEventListener('click', async () => {
            const tradeType = tradeTypeCallBtn.classList.contains('active') ? 'Call' : 'Put';
            const strikePrice = document.getElementById('trade-strike').value;
            const entryPrice = document.getElementById('trade-entry').value;
            const lots = document.getElementById('trade-lots').value;

            if (!strikePrice || !entryPrice || !lots) {
                alert('Please fill in all fields for the trade assistant.');
                return;
            }

            analyzePositionBtn.textContent = 'Analyzing...';
            analyzePositionBtn.disabled = true;

            try {
                await fetch('/api/analyze-position', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tradeType, strikePrice, entryPrice, lots }),
                });
            } catch (error) {
                positionAnalysisContainer.innerHTML = '<p style="color: var(--danger-color);"><strong>Error:</strong> Could not run position analysis.</p>';
            }

            setTimeout(() => {
                analyzePositionBtn.textContent = 'Analyze My Position';
                analyzePositionBtn.disabled = false;
            }, 1500);
        });


        // --- WEBSOCKET LOGIC ---
        const socket = new WebSocket(`ws://localhost:3000`);
        socket.onopen = () => { statusDiv.innerHTML = 'üü¢ <strong>Status:</strong> Live Market Data'; };
        socket.onclose = () => { statusDiv.innerHTML = `üî¥ <strong>Status:</strong> Disconnected. <strong>Restart the app for a live feed.</strong>`; };
        socket.onerror = () => { statusDiv.textContent = 'üî¥ Connection error.'; };
        
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'ai_analysis':
                    updateAIReport(data.content);
                    const timestamp = new Date(data.analysisTimestamp).toLocaleTimeString('en-IN', {
                        timeZone: 'Asia/Kolkata', hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                    aiTimerEl.textContent = `| Last analysis: ${timestamp} IST`;
                    aiReportDetails.open = true; 
                    break;
                case 'position_analysis':
                    positionAnalysisContainer.innerHTML = marked.parse(data.content.trim().replace(/\n{3,}/g, '\n\n'));
                    positionAnalysisCard.classList.remove('hidden');
                    break;
                case 'market_data':
                    statusDiv.innerHTML = `üü¢ <strong>Status:</strong> Live data updated at <strong>${new Date().toLocaleTimeString()}</strong>`;
                    updateDashboard(data.content);
                    break;
                case 'confluence_status':
                    updateConfluenceStatus(data.content);
                    break;
                default:
                    updateDashboard(data);
                    break;
            }
        };

        // --- DATA RENDERING ---
        async function loadInitialData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                statusDiv.innerHTML = '‚ö™Ô∏è <strong>Status:</strong> Off-Market. Displaying last saved data.';
                updateDashboard(data);
            } catch (error) {
                dataContainer.textContent = 'Error loading initial data. Start the Sensi-Stream tool to begin.';
                signalTitle.querySelector('span').textContent = 'Error Loading Data';
                console.error(error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadInitialData();
        });

        // --- COPY BUTTONS ---
        function handleCopy(button, textProvider) {
            navigator.clipboard.writeText(textProvider()).then(() => {
                const originalIcon = button.innerHTML;
                button.innerHTML = `<svg class="icon" style="stroke: var(--success-color);" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                setTimeout(() => { button.innerHTML = originalIcon; }, 2000);
            });
        }
        const copyAiButton = aiReportDetails.querySelector('.icon-button');
        if(copyAiButton) {
            copyAiButton.addEventListener('click', (e) => { e.stopPropagation(); handleCopy(copyAiButton, () => aiAnalysisContainer.innerText); });
        }
        const copyTableButton = document.getElementById('copy-table-button');
        copyTableButton.addEventListener('click', (e) => { e.stopPropagation(); handleCopy(copyTableButton, () => {
            return Array.from(optionsChainDetails.querySelectorAll('tr'))
                .map(row => Array.from(row.querySelectorAll('th, td')).map(cell => cell.innerText).join('\t')).join('\n');
        }); });
        const copyJsonButton = document.getElementById('copy-json-button');
        copyJsonButton.addEventListener('click', (e) => { e.stopPropagation(); handleCopy(copyJsonButton, () => dataContainer.textContent); });
        
        // --- DASHBOARD UPDATE LOGIC ---
        function updateDashboard(data) {
            if (!data || !data.future_price) { dataContainer.textContent = JSON.stringify(data, null, 2); return; }
            const { future_price, atm_strike, pcr, max_pain_strike, atm_iv } = data;
            futurePriceEl.textContent = future_price.toFixed(2);
            atmStrikeEl.textContent = atm_strike;
            pcrEl.textContent = pcr.toFixed(2);
            atmIvEl.textContent = `${(atm_iv * 100).toFixed(2)}%`;
            maxPainEl.textContent = max_pain_strike;
            generateSignal(pcr, atm_strike);
            renderOptionsChainTable(data);
            dataContainer.textContent = JSON.stringify(data, null, 2);
        }

        // --- REWRITTEN: Function to parse and display the AI report ---
        function updateAIReport(content) {
            const lines = content.trim().split('\n');
            const reportData = {};
            
            // 1. Parse each line, cleaning it of markdown characters, and store it in an object
            lines.forEach(line => {
                const parts = line.split(':');
                if (parts.length >= 2) {
                    const key = parts[0].replace(/\*/g, '').trim();
                    const value = parts.slice(1).join(':').replace(/\*/g, '').trim();
                    reportData[key] = value;
                }
            });

            // 2. Update the main Strategy Display Box using the CLEANED data
            const strategy = reportData['Strategy'] || 'Neutral';
            const strike = reportData['Strike Choice'] || 'N/A';
            strategyDisplay.className = '';
            
            if (strategy.toLowerCase().includes('calls')) {
                strategyDisplay.classList.add('strategy-bullish');
                strategyName.textContent = 'BUY CALLS';
                strategyStrike.textContent = `Recommended Strike: ${strike}`;
            } else if (strategy.toLowerCase().includes('puts')) {
                strategyDisplay.classList.add('strategy-bearish');
                strategyName.textContent = 'BUY PUTS';
                strategyStrike.textContent = `Recommended Strike: ${strike}`;
            } else {
                strategyDisplay.classList.add('strategy-neutral');
                strategyName.textContent = 'NEUTRAL';
                strategyStrike.textContent = 'Avoid Trading or Wait for Clearer Signal';
            }

            // 3. Build the new, styled list for the details
            let detailsHtml = '<ul class="strategy-details-list">';
            for (const key in reportData) {
                if (key.toLowerCase() === 'strategy') continue;

                let valueClass = 'data-value';
                if (key.toLowerCase().includes('stop-loss')) valueClass += ' stop-loss';
                if (key.toLowerCase().includes('target')) valueClass += ' target';
                
                // MODIFICATION: Add the 'standard-text' class for these specific keys
                if (key.toLowerCase().includes('exit guideline') || key.toLowerCase().includes('confidence') || key.toLowerCase().includes('rationale')) {
                    valueClass += ' standard-text';
                }
                
                let liClass = '';
                if (key.toLowerCase().includes('rationale')) liClass = 'rationale';

                detailsHtml += `<li class="${liClass}">
                    <span class="data-label">${key}:</span>
                    <span class="${valueClass}">${reportData[key]}</span>
                </li>`;
            }
            detailsHtml += '</ul>';
            
            // 4. Render the new list
            aiAnalysisContainer.innerHTML = detailsHtml;
        }
        
        function updateConfluenceStatus(content) {
            const { status, message, strategy, updateTimestamp, monitorType } = content;
            
            const statusBar = monitorType === 'POSITION' ? positionConfluenceStatus : aiConfluenceStatus;
            
            let iconHtml = '';
            let statusClass = '';

            const formattedTime = new Date(updateTimestamp).toLocaleTimeString('en-IN', {
                timeZone: 'Asia/Kolkata', hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
            });

            switch (status) {
                case 'CONFLUENCE':
                    statusClass = 'status-confluence';
                    iconHtml = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>`;
                    break;
                case 'CAUTION':
                    statusClass = 'status-caution';
                    iconHtml = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`;
                    break;
                case 'DIVERGENCE':
                    statusClass = 'status-divergence';
                    iconHtml = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`;
                    break;
                default:
                    statusClass = 'status-neutral';
                    iconHtml = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;
                    break;
            }
            statusBar.className = `confluence-status ${statusClass}`;
            statusBar.innerHTML = `${iconHtml} <span><strong>${strategy} Position Status:</strong> ${message}</span><span class="timer">| Last check: ${formattedTime}</span>`;
        }

        function generateSignal(pcr, atmStrike) {
            signalContainer.classList.remove('bullish', 'bearish', 'neutral');
            let titleSpan = signalTitle.querySelector('span');
            let icon = signalTitle.querySelector('svg');
            if (pcr < PCR_BULLISH_THRESHOLD) {
                signalContainer.classList.add('bullish');
                titleSpan.textContent = 'Bullish Sentiment';
                icon.innerHTML = `<line x1="12" y1="20" x2="12" y2="4"></line><polyline points="18 10 12 4 6 10"></polyline>`;
                signalDetails.textContent = `Consider CALLs | ATM Strike: ${atmStrike}`;
            } else if (pcr > PCR_BEARISH_THRESHOLD) {
                signalContainer.classList.add('bearish');
                titleSpan.textContent = 'Bearish Sentiment';
                icon.innerHTML = `<line x1="12" y1="4" x2="12" y2="20"></line><polyline points="18 14 12 20 6 14"></polyline>`;
                signalDetails.textContent = `Consider PUTs | ATM Strike: ${atmStrike}`;
            } else {
                signalContainer.classList.add('neutral');
                titleSpan.textContent = 'Neutral Sentiment';
                icon.innerHTML = `<line x1="4" y1="12" x2="20" y2="12"></line>`;
                signalDetails.textContent = `Market appears balanced | ATM Strike: ${atmStrike}`;
            }
        }
        
        function renderOptionsChainTable(data) {
            if (!data || !data.chain) { optionsChainBody.innerHTML = '<tr><td colspan="13">Waiting for options chain data...</td></tr>'; return; }
            const { chain, atm_strike } = data;
            const strikes = Object.keys(chain).map(Number).sort((a, b) => a - b);
            let tableHtml = '';
            for (const strike of strikes) {
                const isAtm = strike === atm_strike;
                const call = chain[strike].call || {};
                const put = chain[strike].put || {};
                const greeks = chain[strike].greeks || {};
                const formatNum = (num) => (num != null && num != 0) ? num.toLocaleString('en-IN') : '--';
                const formatChange = (chg) => {
                    if (chg == null) return '--';
                    const colorClass = chg > 0 ? 'positive-change' : (chg < 0 ? 'negative-change' : '');
                    return `<span class="${colorClass}">${chg.toFixed(2)}</span>`;
                };
                tableHtml += `<tr class="${isAtm ? 'atm-strike-row' : ''}">
                        <td class="call-side">${formatNum(call.oi)}</td>
                        <td class="call-side">${(call.oi_change != null) ? `${(call.oi_change * 100).toFixed(1)}%` : '--'}</td>
                        <td class="call-side">${formatNum(call.volume)}</td>
                        <td class="call-side">${(greeks.iv != null) ? `${(greeks.iv * 100).toFixed(1)}%` : '--'}</td>
                        <td class="call-side">${formatChange(call.absolute_price_change)}</td>
                        <td class="call-side">${call.last_price || '--'}</td>
                        <td class="strike-header">${strike}</td>
                        <td class="put-side">${put.last_price || '--'}</td>
                        <td class="put-side">${formatChange(put.absolute_price_change)}</td>
                        <td class="put-side">${(greeks.iv != null) ? `${(greeks.iv * 100).toFixed(1)}%` : '--'}</td>
                        <td class="put-side">${formatNum(put.volume)}</td>
                        <td class="put-side">${(put.oi_change != null) ? `${(put.oi_change * 100).toFixed(1)}%` : '--'}</td>
                        <td class="put-side">${formatNum(put.oi)}</td>
                    </tr>`;
            }
            optionsChainBody.innerHTML = tableHtml;
        }
    </script>
</body>
</html>